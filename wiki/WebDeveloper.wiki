#sidebar DeveloperTOC

<wiki:toc max_depth="2" />

= Isikutuvastus =

 * Konfigureeri oma veebiserver nõudma kliendipoolset sertifikaati: VeebisAutentimine
 * Kasuta rakenduses vastavaid CGI standardi keskkonnamuutujaid.<br>
   Näiteks: SSL_CLIENT_S_DN, SSL_CLIENT_CERT jne.<br>
   Muutujate nimekirja leiad siit: http://httpd.apache.org/docs/2.0/mod/mod_ssl.html

= Allkirjastamine =
Allkirjastamine toimub läbi universaalse brauseripluginate API. Plugina laadimine on kõigis toetatud brauserites
ühesugune ja seda tehakse järgmise HTML tagiga: 

{{{
<object id="esteid" type="application/x-esteid"
        style="width: 1px; height: 1px;"></object>
}}}

Edasi on võimalik lugeda maha allkirjastamise sertifikaat:
{{{
var esteid = document.getElementById('esteid');
var cert_pem = esteid.signCert.cert;
}}}

Ning pärast vajalike ettevalmistuste tegemist serveri poolel, dokumendi räsi allkirjastada:
{{{
var esteid = document.getElementById('esteid');
esteid.signAsync(hash, "/mywebapp/halfbaked.ddoc", {
    onSuccess: function(signedHash)   { /* Do something with returned signedHash */ },
    onError:   function(errorMessage) { /* Handle error */ }
});

}}}

Laienduse funktsionaalsuse demo leiab aadressilt: https://id.smartlink.ee/plugin_tests/test.html

Üritame kirjutada ka mõningaid näiteprogramme, esimene pääsuke asub siin kataloogis: 
http://code.google.com/p/esteid/source/browse/#svn/jdigidoc/trunk/samples

NB! Igasugune kaastöö on teretulnud ;)

PS! Brauserite pluginad ei ole eraldi komponendid vaid neid levitatakse [InstallStart paigaldatava baastarkvara] koosseisus

== Vanade tehnoloogiate toetamine ==

Kõigil kasutajatel ei ole veel paigaldatud uued pluginad.
Allkirjatehnoloogiat ei ole mõistlik küsida kasutaja käest, kuna ta ei saa
niikuinii päris täpselt aru, mida temalt tahetakse. Tegelikult on võimalik
tuvastada sobiv tehnoloogia automaatselt Javascripti abil.


[https://id.smartlink.ee/plugin-loader/demo.html Vaata DEMO]


Sarnase metoodika realiseeris meile teadaolevatel andmetel esimesena Swedbank.

Vanu pluginaid on nagu kirjuid koeri (kokku rohkem kui neli erinevat)
ja nende kõigi üksipulgi tundmine on väga vaevarikas tegevus. Vanade
tehnoloogiate kergemaks kasutamiseks on loodud teegikomplekt, mille abil
on võimalik laadida uus brauseri plugin ja kui seda ei ole olemas, siis
valida vanadest tehnoloogiatest automaatselt mõni, mis tundub töötavat.

EstEID Plugin Loader on ehitatud nii, et see muudab kõigi vanade pluginate API
identseks uuega, seega ei lisandu veebirakendusse üleliigset "ühilduvuskoodi".
Samuti on vanade tehnoloogiate tugi pakendatud eraldi JS faili, mistõttu on
tulevikus kerge vanade pluginate tugi lõplikult eemaldada.

=== Kasutamine ===

Lae endale plugina laadija komponendid
{{{
svn checkout http://esteid.googlecode.com/svn/esteid-plugin-loader/trunk esteid-plugin-loader
}}}

Lisa laadija komponendid veebilehele
{{{
  <script type="text/javascript" src="esteid.js"></script>
  <script type="text/javascript" src="load-legacy.js"></script>
}}}

Edasi tuleb plugina laadimiseks kasutada järgmist Javascripti koodi
{{{
  estEidLoader.loadPlugin('esteid', {
    pluginReady: function() { /* Enable Signing controls */ },
    pluginFail:  function() { /* Inform user that signing is impossible */ }
  });
}}}

Nüüd saad tekkinud objekti poole pöörduda täpselt sama moodi nagu "päris"
plugina poole.

{{{
var esteid = document.getElementById('esteid');
var cert_pem = esteid.signCert.cert;
}}}

Vaata ka plugina laadija komplektis leiduvat
[http://code.google.com/p/esteid/source/browse/esteid-plugin-loader/trunk/demo.html demo.html]
faili.

=== Vähim võimalik ühisosa ===

Vanad tehnoloogiad ei oska pooltki neid funktsioone, mida toetab uus plugin.
Ühilduvusrežiimilt saab eeldada ainult kõige elementaarsemat allkirjastamise
funktsionaalsust. API translaator toetab vähemalt versiooni küsimist, sertifikaadi
lugemist PEM formaadis ja allkirjastamist:

 * esteid.getVersion
 * esteid.signCert.cert
 * esteid.signAsync

Kas tegemist on "päris" plugina või ühilduvusrežiimiga, saab teada
järgmiselt:
{{{
var esteid = document.getElementById('esteid');
if(esteid.isLegacy) {
  /* Disable some functions that require new plugin */
}
}}}